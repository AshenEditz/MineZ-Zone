<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - MineZ ZONE</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <div class="animated-bg">
        <div class="cube cube-1"></div>
        <div class="cube cube-2"></div>
    </div>

    <header class="header">
        <nav class="navbar">
            <div class="logo" onclick="location.href='index.html'">
                <i class="fas fa-cube"></i>
                <span class="logo-text">MineZ ZONE</span>
            </div>
            <ul class="nav-links">
                <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="admin.html" class="active"><i class="fas fa-shield-alt"></i> Admin</a></li>
            </ul>
        </nav>
    </header>

    <div class="admin-container">
        <div class="admin-box">
            <h1 class="admin-title">
                <i class="fas fa-shield-alt"></i> Admin Panel
            </h1>

            <!-- Stats -->
            <div class="admin-section">
                <h2><i class="fas fa-chart-line"></i> Statistics</h2>
                <div class="admin-stats-grid">
                    <div class="admin-stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <h3 id="adminTotalUsers">0</h3>
                        <p>Users</p>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-icon"><i class="fas fa-file-archive"></i></div>
                        <h3 id="adminTotalContent">0</h3>
                        <p>Content</p>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-icon"><i class="fas fa-download"></i></div>
                        <h3 id="adminTotalDownloads">0</h3>
                        <p>Downloads</p>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-icon"><i class="fas fa-comments"></i></div>
                        <h3 id="adminTotalMessages">0</h3>
                        <p>Messages</p>
                    </div>
                </div>
            </div>

            <!-- Google Drive Backup -->
            <div class="admin-section">
                <h2><i class="fab fa-google-drive"></i> Google Drive Backup</h2>
                <div class="backup-controls">
                    <button onclick="connectGoogleDrive()" class="btn-primary" id="connectBtn">
                        <i class="fab fa-google-drive"></i> Connect Drive
                    </button>
                    <button onclick="manualBackup()" class="btn-secondary" id="backupBtn" disabled>
                        <i class="fas fa-save"></i> Backup Now
                    </button>
                    <button onclick="enableAutoBackup()" class="btn-secondary" id="autoBackupBtn" disabled>
                        <i class="fas fa-clock"></i> Auto Backup
                    </button>
                </div>
                <div id="backupStatus" class="status-message" style="display:none;"></div>
            </div>

            <!-- Export Data -->
            <div class="admin-section">
                <h2><i class="fas fa-database"></i> Data Management</h2>
                <button onclick="exportAllData()" class="btn-primary full-width">
                    <i class="fas fa-download"></i> Export All Data
                </button>
            </div>
        </div>
    </div>

    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/google-drive-backup.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (!auth || !auth.isAdmin()) {
                    alert('❌ Admin only!');
                    window.location.href = 'index.html';
                    return;
                }
                loadAdminStats();
            }, 1000);
        });

        async function loadAdminStats() {
            try {
                const users = await database.ref('users').once('value');
                const content = await database.ref('content').once('value');
                const messages = await database.ref('chat/messages').once('value');
                
                const contentData = content.val() || {};
                let downloads = 0;
                Object.values(contentData).forEach(item => downloads += (item.downloads || 0));

                document.getElementById('adminTotalUsers').textContent = users.numChildren();
                document.getElementById('adminTotalContent').textContent = Object.keys(contentData).length;
                document.getElementById('adminTotalDownloads').textContent = downloads;
                document.getElementById('adminTotalMessages').textContent = messages.numChildren();
            } catch(e) {
                console.error('Error:', e);
            }
        }

        async function connectGoogleDrive() {
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            const success = await driveBackup.signIn();
            if (success) {
                showStatus('✅ Connected!', 'success');
                btn.innerHTML = '<i class="fas fa-check"></i> Connected';
                document.getElementById('backupBtn').disabled = false;
                document.getElementById('autoBackupBtn').disabled = false;
            } else {
                showStatus('❌ Failed', 'error');
                btn.innerHTML = '<i class="fab fa-google-drive"></i> Connect Drive';
            }
        }

        async function manualBackup() {
            const btn = document.getElementById('backupBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Backing up...';
            const result = await driveBackup.backupAllData();
            showStatus(result.success ? '✅ Backup complete!' : '❌ Failed', result.success ? 'success' : 'error');
            btn.innerHTML = '<i class="fas fa-save"></i> Backup Now';
        }

        function enableAutoBackup() {
            driveBackup.startAutoBackup();
            showStatus('✅ Auto-backup enabled!', 'success');
        }

        async function exportAllData() {
            try {
                const data = {
                    users: (await database.ref('users').once('value')).val(),
                    content: (await database.ref('content').once('value')).val(),
                    chat: (await database.ref('chat/messages').once('value')).val()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `minezone-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                showStatus('✅ Exported!', 'success');
            } catch(e) {
                showStatus('❌ Failed', 'error');
            }
        }

        function showStatus(msg, type) {
            const status = document.getElementById('backupStatus');
            status.style.display = 'block';
            status.className = 'status-message ' + type;
            status.textContent = msg;
            setTimeout(() => status.style.display = 'none', 5000);
        }
    </script>
</body>
</html>